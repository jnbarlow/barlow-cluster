<html>
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS -->
        <link rel='stylesheet' type='text/css' href='/vendor/bootstrap/dist/css/bootstrap.min.css'>

        <style>
            .stats .card {
                margin-bottom:20px;
                transition: background-color 0.5s ease .1s;
            }
            .pulse {
                background-color:khaki;
                transition: background-color 0.5s ease .1s;
            }
        </style>

        <!-- js -->
        <script src='/vendor/jquery/dist/jquery.min.js'></script>

        <!-- socket stuff -->
        <script src='/vendor/socket.io-client/dist/socket.io.js'></script>
        <script>
            const socket = io();
            socket.on('beat', (data)=>{
                generateCard(data);
            });

            /**
             * generates the card for each worker
             */
            function generateCard(worker){
                const card = $(`#${worker.id}`);
                const stats = $('.stats');
                const memUnit = (worker.memory.total > 1073741824)? 'GB' : 'MB';
                const totalMem = memUnit == 'GB'? worker.memory.total/1073741824 : worker.memory.total/1048576;
                const usedMem = memUnit == 'GB'? worker.memory.used/1073741824 : worker.memory.used/1048576;
                const freeMem = memUnit == 'GB'? worker.memory.free/1073741824 : worker.memory.free/1048576;

                const innerHtml = `
                    <div class='card'>
                        <div class='card-body'>
                            <h5>Node: ${worker.id}</h5>
                            <hr>
                            <div>Address: ${worker.address}</div><br>
                            <div>CPU Load: ${worker.load.currentLoad.toFixed(2)}%</div><br>
                            <div>
                                Memory:
                                <ul>
                                    <li>Total: ${totalMem.toFixed(2)} ${memUnit}</li>
                                    <li>Used: ${usedMem.toFixed(2)} ${memUnit}</li>
                                    <li>Free: ${freeMem.toFixed(2)} ${memUnit}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;

                const html = `
                <div class='col-md-4' id=${worker.id}>
                    ${innerHtml}
                </div>
                `;

                if(!card.length){
                    stats.append(html);
                } else {
                    card.html(innerHtml);
                }
                setTimeout(()=>{pulse(worker.id)}, 100);
            }

            function pulse(id) {
                const card = $(`#${id} .card`);
                card.toggleClass('pulse');
                setTimeout(()=>{card.toggleClass('pulse');}, 750);
            }
        </script>

        <title>Barlow Cluster Status</title>
    </head>
    <body>
        <div class="jumbotron jumbotron-fluid">
            <div class="container">
              <h1 class="display-4">Barlow Cluster</h1>
              <p class="lead">Status page for your cluster, including resources for your connected clients.</p>
            </div>
          </div>
        <div class='container-fluid'>
            <div class='row stats'>

            </div>
        </div>
    </body>
</html>
